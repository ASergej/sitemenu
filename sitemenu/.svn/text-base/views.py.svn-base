from django.shortcuts import render_to_response, get_object_or_404
from django.template import RequestContext
from django.http import Http404, HttpResponseRedirect
from site_menu.models import Menu
from django.core.urlresolvers import reverse
from cars.views import render_carspage, render_login

def dispatcher(request, url):

    if not url.endswith('/'):
        return HttpResponseRedirect(reverse('dispatcher', kwargs={'url':url+'/'}))
    print url
    try:
        menu = Menu.objects.filter(full_url=url, enabled=True)[:1]
        menu = menu[0]
    except:
        menu = None

    if menu:

        if menu.page_type == 'text':
            return render_menupage(request, menu)
        elif menu.page_type == 'cars':
            return render_carspage(request, menu)
        elif menu.page_type == 'logn':
            return render_login(request, menu)
        elif menu.page_type == 'redr':
            return HttpResponseRedirect(menu.redirect_url)
        elif menu.page_type == 'indx':
            return HttpResponseRedirect(reverse('home'))

    url_arr = url.split('/')[:-1]
    url_add = []
    while url_arr:
        try:
            menu = Menu.objects.get(enabled=True, full_url='/'.join(url_arr)+'/')
            break
        except:
            url_add.append(url_arr[-1])
            url_arr = url_arr[:-1]
    if menu:
        url_add = list(reversed(url_add))
        if 'compare' in url_add:
            return render_comparepage(request, menu, url_add)
        if url_add[0] == 'all':
            return render_productspage_all(request, menu, url_add)
        elif menu.page_type == 'prod':
            return render_productpage(request, menu, url_add)

    raise Http404


def render_menupage(request, menu):
    return render_to_response('menu/textpage.html', {
        }, context_instance = RequestContext(request, {
            'menupage': menu,
        }
    ))
